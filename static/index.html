<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Connect 5</title>
		<link rel="stylesheet" href="style.css">
		<link rel="shortcut icon" href="favicon.ico">
	</head>

	<body>
		<h1>Connect 5</h1>
		<h2>Joe O'Regan</h2>
		
		<div class="selectGame" id="selectGame">		
			<div>
				<h3>Play A Game</h3>
				
				<p><b>Player 1:</b> Enter Username and select "New Game"</p>
				<p><b>Player 2:</b> Enter Username and Game ID. Then Select "Existing Game"</p>
			</div>
			
			<h4>Create a new Game</h4>
			
			<input type="text" id="username1" placeholder="Username" required>
			<button class="button" id="newGameBtn">Create Game</button>				
			
			<br><br>
			
			<h4>Join an existing game</h4>
			<input type="text" id="username2" placeholder="Username" required>
			<input type="text" id="gameID" placeholder="Game To Join" required>
			<button class="button" id="existingBtn">Join Game</button>
		</div>
		<br><br>		
			
		<div class="gameBoard" id="gameBoard" align="center" style="display: none;">
			<h3 id="username"></h3>
			<p id="displayMessage"></p>
			
			<table class="frame" id="frame2">
				<tr>
				<td id="0" class="column" title="Column 1">
					<table>
						<tr><td class="col0" id="0"></td></tr>
						<tr><td class="col0" id="1"></td></tr>
						<tr><td class="col0" id="2"></td></tr>
						<tr><td class="col0" id="3"></td></tr>
						<tr><td class="col0" id="4"></td></tr>
						<tr><td class="col0" id="5"></td></tr>
					</table>
				</td>
				<td id="1" class="column" title="Column 2">
					<table>
						<tr><td class="col1" id="0"></td></tr>
						<tr><td class="col1" id="1"></td></tr>
						<tr><td class="col1" id="2"></td></tr>
						<tr><td class="col1" id="3"></td></tr>
						<tr><td class="col1" id="4"></td></tr>
						<tr><td class="col1" id="5"></td></tr>
					</table>
				</td>
				<td id="2" class="column" title="Column 3">
					<table>
						<tr><td class="col2" id="0"></td></tr>
						<tr><td class="col2" id="1"></td></tr>
						<tr><td class="col2" id="2"></td></tr>
						<tr><td class="col2" id="3"></td></tr>
						<tr><td class="col2" id="4"></td></tr>
						<tr><td class="col2" id="5"></td></tr>
					</table>
				</td>
				<td id="3" class="column" title="Column 4">
					<table>
						<tr><td class="col3" id="0"></td></tr>
						<tr><td class="col3" id="1"></td></tr>
						<tr><td class="col3" id="2"></td></tr>
						<tr><td class="col3" id="3"></td></tr>
						<tr><td class="col3" id="4"></td></tr>
						<tr><td class="col3" id="5"></td></tr>
					</table>
				</td>
				<td id="4" class="column" title="Column 5">
					<table>
						<tr><td class="col4" id="0"></td></tr>
						<tr><td class="col4" id="1"></td></tr>
						<tr><td class="col4" id="2"></td></tr>
						<tr><td class="col4" id="3"></td></tr>
						<tr><td class="col4" id="4"></td></tr>
						<tr><td class="col4" id="5"></td></tr>
					</table>
				</td>
				<td id="5" class="column" title="Column 6">
					<table>
						<tr><td class="col5" id="0"></td></tr>
						<tr><td class="col5" id="1"></td></tr>
						<tr><td class="col5" id="2"></td></tr>
						<tr><td class="col5" id="3"></td></tr>
						<tr><td class="col5" id="4"></td></tr>
						<tr><td class="col5" id="5"></td></tr>
					</table>
				</td>
				<td id="6" class="column" title="Column 7">
					<table>
						<tr><td class="col6" id="0"></td></tr>
						<tr><td class="col6" id="1"></td></tr>
						<tr><td class="col6" id="2"></td></tr>
						<tr><td class="col6" id="3"></td></tr>
						<tr><td class="col6" id="4"></td></tr>
						<tr><td class="col6" id="5"></td></tr>
					</table>
				</td>
				<td id="7" class="column" title="Column 8">
					<table>
						<tr><td class="col7" id="0"></td></tr>
						<tr><td class="col7" id="1"></td></tr>
						<tr><td class="col7" id="2"></td></tr>
						<tr><td class="col7" id="3"></td></tr>
						<tr><td class="col7" id="4"></td></tr>
						<tr><td class="col7" id="5"></td></tr>
					</table>
				</td>
				<td id="8" class="column" title="Column 9">
					<table>
						<tr><td class="col8" id="0"></td></tr>
						<tr><td class="col8" id="1"></td></tr>
						<tr><td class="col8" id="2"></td></tr>
						<tr><td class="col8" id="3"></td></tr>
						<tr><td class="col8" id="4"></td></tr>
						<tr><td class="col8" id="5"></td></tr>
					</table>
				</td>
				</tr>
			</table>			
			<br>			
			
			<div><h2 id="player_info"></h2></div>
			
			<button onClick="startGame()" class="button">Replay</button>
			<button onClick="refreshPage()()" class="button">Leave Game</button>
		</div>
		
		<div>
			<h2>Links</h2>
			<a href="https://github.com/joeaoregan/Connect5-JS" target="_blank">Connect 5 GitHub</a>
		</div>
	
	<script src="/socket.io/socket.io.js"></script>
	<script>
			const socket = io();
			const ROWS = 6, COLS = 9;
			const PLAYER_1 = 1, PLAYER_2 = 2;

			var board = [[0,0,0,0,0,0,0,0,0],	// init board
						 [0,0,0,0,0,0,0,0,0],
						 [0,0,0,0,0,0,0,0,0],
						 [0,0,0,0,0,0,0,0,0],
						 [0,0,0,0,0,0,0,0,0],
						 [0,0,0,0,0,0,0,0,0]];			
			var winBoard;
			var player, game;

			const columns = document.querySelectorAll('.column');
			var cols=[];
			for (var i = 0; i < 9; i++) {
				cols[i] = document.querySelectorAll('.col'+i);	// Used to draw the disks
			}
			document.querySelector('#newGameBtn').addEventListener('click', username1Button, false);
			document.querySelector('#existingBtn').addEventListener('click', username2Button, false);

			class Player {
				constructor(name, type) {
					this.name = name;
					this.type = type;
					this.turn = false;
				}
			}

			class Game {
				constructor(gameID) {
					this.readyToPlay = false;
					this.gameID = gameID;
					this.board = board;
					this.gameOver = false;		
					this.winBoard = board;
					this.currentPlayer = 0;
				}	
				
				setCurrentPlayer(player) { this.currentPlayer=player; }
				getGameID() { return this.gameID; }
				setReadyToPlay(ready) { this.readyToPlay = ready; }
				setGameOver(gameOver) { this.gameOver=gameOver; }
				getBoard() { return this.board; }
				
				init() {
					this.board = board;
					resetBoard(board);					// Reset: clears the board
					console.log('\x1b[36mStart Game!!! ' + this.gameID);
					this.drawBoard(this.board);						// Reset: Draw the reset board
							
					if (columns && !this.gameOver) {
						for (var i = 0; i < columns.length; i++) {
							columns[i].addEventListener('click', handleClicks, false);
						}	
					}
				}	
				
				turn(colID) {
					if (player.type == this.currentPlayer){		
						if (player.turn) {
							socket.emit('takeTurn', {
								column: colID,
								gameID: this.gameID
							});
						}
						
						console.log('draw board after taking go');
						this.drawBoard(this.board);
						
						player.turn = false;
					
						console.log('Your Turn - column: ' + colID);
					} else {
						console.log('Not Your Turn Yet - column: ' + colID);
					}
				}
				
				drawBoard(board) {	 
					for (var row = 0; row < ROWS; row++) {
						for (var col = 0; col < COLS; col++) {	
							if (board[row][col] == 0)
								cols[col][row].style.backgroundImage="linear-gradient(to bottom right, white, grey))";	// empty		
							else if (board[row][col] == 1)
								cols[col][row].style.backgroundImage="linear-gradient(to bottom right, red, darkred)";	// player 1
							else if (board[row][col] == 2)
								cols[col][row].style.backgroundImage="linear-gradient(to bottom right, yellow, orange)";// player 2
							else if (board[row][col] == 3)
								cols[col][row].style.backgroundImage="linear-gradient(to bottom right, lime, green)";	// winning line
						}
					}
					
					if (!this.gameOver) {
						document.getElementById("player_info").innerText = (this.currentPlayer === 0) ? "Waiting on Player 2 to join" : (this.currentPlayer==PLAYER_1) ? "Player 1 Go" : "Player 2 Go";
					} else {
						document.getElementById("player_info").innerText = "Player "+this.currentPlayer+" Is The Winner!";
					}
					document.getElementById("player_info").style.color = (this.currentPlayer==PLAYER_1) ? "red" : "orange";
				}

				showGame(data) {
					document.getElementById("selectGame").style.display = "none";
					document.getElementById("gameBoard").style.display = "inline";	
					document.getElementById("username").innerText = "Player " + player.type + ": " + player.name;
					
					if (!this.currentPlayer == PLAYER_1) {
						document.getElementById("displayMessage").innerText = "Welcome "+ player.name + ". Player 2 must enter Game ID: \"" + data.gameID + "\" to join";
					} else {
						//document.getElementById("displayMessage").innerText = "Welcome "+ player.name + ", now playing " + data.name;	////////////////////////////////////////////////// NEED TO GET PLAYER 1 NAME HERE
						document.getElementById("displayMessage").innerText = "Welcome "+ player.name;	////////////////////////////////////////////////// NEED TO GET PLAYER 1 NAME HERE
					}
				}
			}
				
			socket.on('newGame', (data) => {
				game = new Game(data.gameID);
				game.init();
				game.showGame({name: data.username, gameID: data.gameID});
			});

			socket.on('player1', (data) => {
				console.log('Player 1 Init');
				game.currentPlayer = PLAYER_1;
				game.drawBoard(game.getBoard());
			});

			// Create game for player 2
			socket.on('player2', (data) => {
				console.log('Player 2 Init');
				game = new Game(data.gameID);
				game.setCurrentPlayer(PLAYER_1);
				game.init();
				game.showGame({name: data.username, gameID: data.gameID});
			});

			socket.on('turnPlayed', (data) => {
				console.log('turn played & board updated');	
				game.board = data.board;
				game.setCurrentPlayer(data.player);
				game.drawBoard(data.board);
				console.log('Current Player Now: ' + data.player);
				player.turn = true;
			});

			socket.on('gameOver', (data) => {
				console.log('Game Finished');
				game.setGameOver(true);	
				
				game.board = data.board;
				game.setCurrentPlayer(data.player);	
				game.drawBoard(data.board);
				//socket.leave(data.room);	
			});


			function handleClicks(col) {
				if (!game.gameOver && player.type == game.currentPlayer) {
					//console.log('Player %d column selected: %s', currentPlayer, col.currentTarget.id);
					//turn(col.currentTarget.id, currentPlayer);	
					game.turn(col.currentTarget.id);	
					
					//socket.emit('col', {column : col.currentTarget.id, player: currentPlayer})
					socket.emit('col', {column : col.currentTarget.id, player: player.type, gameID: game.getGameID()})
				}
			}

			function username1Button() {
				var username1 = document.getElementById("username1").value;
				
				if (!username1) {
				  alert('Please Enter A Username To Play');
				  return;
				}
				
				socket.emit('create', { username: username1 });
				player = new Player(username1, PLAYER_1);
			}

			function username2Button() {
				var username2 = document.getElementById("username2").value;
				var gameIDField = document.getElementById("gameID").value;
				
				if (!username2 || !gameIDField) {
				  alert('Please Enter BOTH Username And Game ID');
				  return;
				}
				
				//console.log('Client (username2Button) - Username: ' + username2 + ' Game ID: ' + gameIDField);	
				socket.emit('player2join', { username: username2, gameID: gameIDField });
				player = new Player(username2, PLAYER_2);
				//game.setCurrentPlayer(PLAYER_1);
			}

			function startGame() {
				console.log('Start New Game');
				//socket.emit('newGame', { username: data.username, gameID: `game-${games}` });
				game = new Game(game.gameID);
				game.init();
			}

			function resetBoard(board) {
				for (var row = 0; row < ROWS; row++) {
					for (var col = 0; col < COLS; col++) {
						board[row][col] = 0;			
						cols[col][row].style.backgroundImage="";	// Reset coloured cells
					}
				}
			}

			function refreshPage() {
				location.reload();
			}
	</script>
</body>
</html>